name: Fix SmartNews Feed

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  update-feed:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Fetch and update SmartNews feed
        run: |
          FEED_URL="https://www.cabletv.com/blog/category/entertainment/feed"
          LOGO_URL="https://raw.githubusercontent.com/WatchCTV/SmartNews/main/CTV-Feed-Logo.png"

          echo "ðŸ“¡ Downloading feed..."
          curl -sSL "$FEED_URL" -o feed.xml

          echo "ðŸ§© Injecting logo and thumbnails..."
          python3 <<'PYCODE'
          import re, xml.etree.ElementTree as ET
          from xml.dom import minidom

          tree = ET.parse("feed.xml")
          root = tree.getroot()
          ns = {'media': 'http://search.yahoo.com/mrss/'}

          # Add SmartNews logo
          channel = root.find("channel")
          if channel is not None and channel.find("snf:logo", namespaces=ns) is None:
              logo = ET.SubElement(channel, "snf:logo")
              url = ET.SubElement(logo, "url")
              url.text = "https://raw.githubusercontent.com/WatchCTV/SmartNews/main/CTV-Feed-Logo.png"

          # Ensure thumbnails
          for item in root.findall("channel/item"):
              if item.find("media:thumbnail", ns) is None:
                  match = re.search(r'src="([^"]+)"', "".join(item.itertext()))
                  if match:
                      thumb = ET.SubElement(item, "{http://search.yahoo.com/mrss/}thumbnail")
                      thumb.set("url", match.group(1))

          xml_str = minidom.parseString(ET.tostring(root)).toprettyxml(indent="  ")
          with open("feed.xml", "w", encoding="utf-8") as f:
              f.write(xml_str)
          PYCODE

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add feed.xml
          git diff --quiet && echo "âœ… No changes." || (git commit -m "Auto update SmartNews feed" && git push)
