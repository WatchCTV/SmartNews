name: Fix SmartNews Feed
on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'
jobs:
  update-feed:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Install lxml
        run: pip install lxml --break-system-packages
      
      - name: Fix feed
        run: |
          curl -sSL "https://www.cabletv.com/blog/category/entertainment/feed" -o feed.xml
          
          python3 <<'EOF'
          from lxml import etree
          import re
          
          parser = etree.XMLParser(strip_cdata=False)
          tree = etree.parse("feed.xml", parser)
          root = tree.getroot()
          
          # Define namespaces
          SNF_NS = 'http://www.smartnews.be/snf'
          MEDIA_NS = 'http://search.yahoo.com/mrss/'
          CONTENT_NS = 'http://purl.org/rss/1.0/modules/content/'
          
          # Register with proper prefixes
          etree.register_namespace('snf', SNF_NS)
          etree.register_namespace('media', MEDIA_NS)
          
          channel = root.find('channel')
          
          # Add logo with snf: prefix
          desc = channel.find('description')
          desc_index = list(channel).index(desc)
          logo = etree.Element(f'{{{SNF_NS}}}logo')
          logo.text = 'https://raw.githubusercontent.com/WatchCTV/SmartNews/main/CTV-Feed-Logo.png'
          channel.insert(desc_index + 1, logo)
          
          # Process items
          for item in channel.findall('item'):
              # Add thumbnail
              thumb = etree.Element(f'{{{MEDIA_NS}}}thumbnail')
              thumb.set('url', 'https://raw.githubusercontent.com/WatchCTV/SmartNews/main/CTV-Feed-Logo.png')
              item.insert(0, thumb)
              
              # Fix content:encoded with CDATA
              content = item.find(f'{{{CONTENT_NS}}}encoded')
              if content is not None:
                  text = content.text if content.text else ''
                  # Limit links
                  links = re.findall(r'<a[^>]*href="[^"]*"[^>]*>.*?</a>', text, re.DOTALL)
                  if len(links) > 3:
                      for link in links[3:]:
                          match = re.search(r'>([^<]+)<', link)
                          if match:
                              text = text.replace(link, match.group(1), 1)
                  
                  # Set as CDATA
                  content.text = etree.CDATA(text)
              
              # Add analytics as ATTRIBUTE not CDATA
              link = item.find('link')
              if link is not None and link.text:
                  analytics = etree.Element(f'{{{SNF_NS}}}analytics')
                  analytics.set('url', link.text)  # Use attribute, not text content
                  item.append(analytics)
          
          # Write with proper encoding
          tree.write('feed.xml', encoding='utf-8', xml_declaration=True, pretty_print=True)
          EOF
      
      - name: Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add feed.xml
          git diff --quiet --staged || git commit -m "Update SmartNews feed"
          git push
