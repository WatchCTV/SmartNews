name: Build SmartNews Feed

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build SmartNews Feed
        run: |
          pip install requests lxml beautifulsoup4

          python3 <<'EOF'
          import requests, re, html, unicodedata
          from urllib.parse import urlsplit, urlunsplit, quote
          from lxml import etree
          from bs4 import BeautifulSoup

          SOURCE_URL = 'https://rss.app/feeds/PnXLTXpDQSdLv1cb.xml'
          SELF_URL   = 'https://watchctv.github.io/SmartNews/feed.xml'
          LOGO_URL   = 'https://i.ibb.co/sptKgp34/CTV-Feed-Logo.png'

          def sanitize_url(u: str) -> str | None:
              if not u:
                  return None
              u = unicodedata.normalize('NFKC', u.strip())
              u = u.replace('–', '-').replace('—', '-').replace('−', '-')
              if u.startswith('//'):
                  u = 'https:' + u
              if u.startswith('/'):
                  u = 'https://www.cabletv.com' + u
              parts = urlsplit(u)
              clean_path = quote(parts.path)
              return urlunsplit((parts.scheme, parts.netloc, clean_path, parts.query, parts.fragment))

          print("Fetching source feed...")
          xml = requests.get(SOURCE_URL, timeout=30).text
          soup = BeautifulSoup(xml, 'xml')

          rss = etree.Element('rss', version='2.0',
              nsmap={
                  'content': 'http://purl.org/rss/1.0/modules/content/',
                  'wfw': 'http://wellformedweb.org/CommentAPI/',
                  'dc': 'http://purl.org/dc/elements/1.1/',
                  'atom': 'http://www.w3.org/200
