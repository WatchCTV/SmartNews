name: Build SmartNews Feed

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"  # runs daily at 6 AM UTC (11 PM MT the night before)
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip pytz feedparser

      - name: Generate feed.xml (SmartNews)
        run: |
          python3 - <<'EOF'
          import datetime, pytz, xml.etree.ElementTree as ET, os

          FEED_FILE = "feed.xml"
          MTN = pytz.timezone("US/Mountain")
          now = datetime.datetime.now(MTN)

          if not os.path.exists(FEED_FILE):
              raise FileNotFoundError(f"{FEED_FILE} not found")

          tree = ET.parse(FEED_FILE)
          root = tree.getroot()

          for item in root.findall(".//item"):
              pub = item.find("pubDate")
              if pub is not None:
                  text = pub.text.strip() if pub.text else ""
                  try:
                      # Try parsing “October 26, 2025” style dates
                      dt = datetime.datetime.strptime(text, "%B %d, %Y")
                      dt_mt = MTN.localize(dt.replace(hour=0, minute=0))
                      pub.text = dt_mt.strftime("%a, %d %b %Y %H:%M:%S %z")
                  except Exception:
                      # Already a valid format, skip
                      continue
              else:
                  # Add missing pubDate
                  pub = ET.SubElement(item, "pubDate")
                  pub.text = now.strftime("%a, %d %b %Y %H:%M:%S %z")

          tree.write(FEED_FILE, encoding="utf-8", xml_declaration=True)
          EOF

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin main
          git add feed.xml
          git commit -m "Auto-update SmartNews feed with RFC-822 pubDate in Mountain Time (UTC-7)" || echo "No changes to commit"
          git push origin main
