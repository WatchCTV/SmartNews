name: Fix SmartNews Feed

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # Runs every 6 hours

jobs:
  update-feed:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install lxml requests

      - name: Fetch and fix SmartNews feed
        run: |
          curl -sSL "https://www.cabletv.com/blog/category/entertainment/feed" -o original.xml

          python3 <<'EOF'
          from lxml import etree

          SNF_NS = "http://www.smartnews.be/snf"
          nsmap = {"snf": SNF_NS}

          parser = etree.XMLParser(strip_cdata=False)
          tree = etree.parse("original.xml", parser)
          root = tree.getroot()

          # Ensure namespace is declared
          if "snf" not in root.nsmap:
              root.attrib["xmlns:snf"] = SNF_NS

          channel = root.find("channel")

          # Add SmartNews <snf:logo> and <snf:darkModeLogo>
          def add_logo(tag, url):
              el = etree.Element(f"{{{SNF_NS}}}{tag}")
              url_el = etree.SubElement(el, "url")
              url_el.text = url
              return el

          logo_url = "https://www.cabletv.com/images/CTV-Feed-Logo.png"
          dark_logo_url = "https://www.cabletv.com/images/CTV-Feed-Logo-Dark.png"

          # Remove old logos if any
          for old_tag in ["snf:logo", "snf:darkModeLogo"]:
              old = channel.find(old_tag, nsmap)
              if old is not None:
                  channel.remove(old)

          channel.append(add_logo("logo", logo_url))
          channel.append(add_logo("darkModeLogo", dark_logo_url))

          # Write output
          tree.write("feed.xml", encoding="utf-8", xml_declaration=True)
          EOF

      - name: Commit and push updated feed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          mv feed.xml ./feed.xml
          git add feed.xml
          git commit -m "Auto-update SmartNews feed"
          git push
