name: Fix SmartNews Feed
on:
  workflow_dispatch:
jobs:
  update-feed:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Inject SmartNews logo and thumbnails
        run: |
          FEED_URL="https://www.cabletv.com/blog/category/entertainment/feed"
          curl -sSL "$FEED_URL" -o feed.xml
          
          python3 <<'PYCODE'
          import xml.etree.ElementTree as ET
          import re
          
          tree = ET.parse("feed.xml")
          root = tree.getroot()
          channel = root.find("channel")
          
          # Add logo to channel
          logo = ET.Element("{http://www.smartnews.be/snf}logo")
          logo.text = "https://raw.githubusercontent.com/WatchCTV/SmartNews/main/CTV-Feed-Logo.png"
          channel.insert(3, logo)
          
          # Fix each item
          for item in channel.findall("item"):
              # Add thumbnail
              thumb = ET.Element("{http://search.yahoo.com/mrss/}thumbnail")
              thumb.set("url", "https://raw.githubusercontent.com/WatchCTV/SmartNews/main/CTV-Feed-Logo.png")
              item.insert(0, thumb)
              
              # Limit links in content:encoded
              content = item.find("{http://purl.org/rss/1.0/modules/content/}encoded")
              if content is not None and content.text:
                  links = re.findall(r'<a[^>]*>.*?</a>', content.text, re.DOTALL)
                  if len(links) > 3:
                      for link in links[3:]:
                          match = re.search(r'>([^<]+)<', link)
                          if match:
                              content.text = content.text.replace(link, match.group(1), 1)
              
              # Add analytics
              link_elem = item.find("link")
              if link_elem is not None and link_elem.text:
                  analytics = ET.Element("{http://www.smartnews.be/snf}analytics")
                  analytics.set("url", link_elem.text)
                  item.append(analytics)
          
          tree.write("feed.xml", encoding="utf-8", xml_declaration=True)
          PYCODE
      
      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add feed.xml
          git diff --quiet || (git commit -m "Fix SmartNews feed" && git push)
